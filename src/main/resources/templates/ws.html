<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit">

    <title>消息通讯</title>
    <link th:href="@{css/bootstrap.min.css}" rel="stylesheet"/>

    <link th:href="@{font-awesome/css/font-awesome.css}" rel="stylesheet">

    <!-- Morris -->
    <link th:href="@{css/plugins/morris/morris-0.4.3.min.css}" rel="stylesheet">

    <!-- Gritter -->
    <link th:href="@{js/plugins/gritter/jquery.gritter.css}" rel="stylesheet">

    <link th:href="@{css/animate.css}" rel="stylesheet">
    <link th:href="@{css/style.css}" rel="stylesheet">
</head>
<body onload="disconnect()">
<div id="wrapper">
    <!--菜单栏-->
    <nav th:replace="index :: navModal"></nav>
    <div id="page-wrapper" class="gray-bg dashbard-1">
        <!--顶部栏-->
        <div th:replace="index :: navBorderTop"></div>
        <!--内容栏-->
        <div class="wrapper wrapper-content animated fadeInRight">
            <div class="row" style="margin-top: 30px;">
                <div class="form-horizontal" role="form">
                    <div class="form-group">
                        <label for="user" class="col-sm-2 col-xs-12 control-label">姓名: </label>
                        <div class="col-sm-4 col-xs-12">
                            <input type="text" class="form-control" id="user" placeholder="请输入姓名">
                        </div>
                        <div class="col-sm-5 col-xs-12">
                            <button class="btn btn-info" id="connect" onclick="connect();">登录</button>
                            <button class="btn btn-danger" id="disconnect" disabled="disabled" onclick="disconnect();">下线</button>
                        </div>
                    </div>
                    <div class="form-group" id="conversationDiv">
                        <label for="msg" class="col-sm-2 col-xs-12 control-label">消息: </label>
                        <div class="col-sm-5 col-xs-12">
                            <textarea type="text" id="msg" style="width: 100%;height: 113px"
                                      placeholder="消息内容..."></textarea>
                        </div>
                    </div>
                    <div class="form-group" id="sendBtn">
                        <div class="col-sm-offset-6 col-sm-1 col-xs-12">
                            <button type="button" class="btn btn-success" style="width:100%" id="sendName"
                                    onclick="sendMsg();">发送
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-sm-offset-2 col-sm-5 col-xs-12">
                    <div id="msgWindows">
                        <div class="panel panel-info" style="margin-top: 20px">
                            <div class="panel-heading">
                                <h3 class="panel-title">聊天记录</h3>
                            </div>
                            <div class="panel-body">
                                <p id="response"></p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <!--尾部栏-->
        <div th:replace="index :: footer"></div>
    </div>
</div>
</body>
<script th:src="@{js/sockjs.min.js}"></script>
<script th:src="@{js/stomp.min.js}"></script>
<script th:src="@{js/moment.js}"></script>
<script th:src="@{js/jquery3.3.1.js}"></script>
<script th:src="@{js/bootstrap.min.js}"></script>
<script th:src="@{js/plugins/metisMenu/jquery.metisMenu.js}"></script>
<script th:src="@{js/plugins/slimscroll/jquery.slimscroll.min.js}"></script>

<!-- Flot -->
<script th:src="@{js/plugins/flot/jquery.flot.js}"></script>
<script th:src="@{js/plugins/flot/jquery.flot.tooltip.min.js}"></script>
<script th:src="@{js/plugins/flot/jquery.flot.spline.js}"></script>
<script th:src="@{js/plugins/flot/jquery.flot.resize.js}"></script>
<script th:src="@{js/plugins/flot/jquery.flot.pie.js}"></script>
<script th:src="@{js/plugins/flot/jquery.flot.symbol.js}"></script>

<!-- Peity -->
<script th:src="@{js/plugins/peity/jquery.peity.min.js}"></script>
<script th:src="@{js/demo/peity-demo.js}"></script>

<!-- Custom and plugin javascript -->
<script th:src="@{js/hplus.js?v=2.2.0}"></script>
<script th:src="@{js/plugins/pace/pace.min.js}"></script>
<!-- jQuery UI -->
<script th:src="@{js/plugins/jquery-ui/jquery-ui.min.js}"></script>
<script th:src="@{js/config.js}"></script>
<script type="text/javascript">
    var stompClient = null;
    var userName = null;
    $('body').keyup(function (e) {
        var event = e || window.event;
        var code = event.keyCode || event.which || event.charCode;
        if (code == 13) {
            sendMsg();
        }
    });

    function setConnected(connected) {
        document.getElementById('connect').disabled = connected;
        document.getElementById('user').disabled = connected;
        document.getElementById('disconnect').disabled = !connected;
        document.getElementById('conversationDiv').style.visibility = connected ? 'visible' : 'hidden';
        document.getElementById('msgWindows').style.visibility = connected ? 'visible' : 'hidden';
        document.getElementById('sendBtn').style.visibility = connected ? 'visible' : 'hidden';
        $('#response').html();
    }

    function connect() {
        var user = $('#user').val();
        if (user == null || user.trim().length==0) {
            showModel('提示', '请输入姓名!');
        } else {
            userName = user;
            var socket = new SockJS('/endpointWisely');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, function (frame) {
                setConnected(true);
                console.log('连接:' + frame);
                stompClient.subscribe('/topic/getResponse', function (response) {
                    showResponse(JSON.parse(response.body));
                });
            });
        }
    }

    function disconnect() {
        if (stompClient != null) {
            stompClient.disconnect()
        }
        setConnected(false);
        console.log('连接断开');
        //菜单跳转
        $('.nav li').removeClass('active');
        $('.chart').addClass('active');
    }

    //消息发送
    function sendMsg() {
        var msg = $('#msg').val();
        if (msg == null || msg == "") {
            showModel('提示', '消息不能为空！')
        }
        $('#msg').val('');
        var data = {
            'userName': userName,
            'msg': msg
        };
        stompClient.send('/welcome', {}, JSON.stringify(data));
    }

    //消息接收
    function showResponse(data) {
        var html = '<div class="msgInfo">';
        if (data.sendUser != userName) {
            call();//消息提醒
            html += '<span style="color: #3657f9;font-weight: 500;font-family: cursive; font-size: 16px;">'
        } else {
            html += '<span style="color: #478a14;font-weight: 500;font-family: cursive; font-size: 16px;">'
        }
        html += data.sendUser;
        html += '&nbsp;' + data.time;
        html += '</span>';
        html += '</br><div style="color: #2b2a2a;font-size: 16px;margin: 5px 0 5px 29px;">' + data.responseMessage + '</div>';
        html += '</div>';
        $('#response').prepend(html);
        //长度限制
        var $index = $('.msgInfo').length;
        if ($index >= 15) {
            $('.msgInfo:last').remove();
        }

    }

    //震动
    function shake() {
        if (window.top.moveBy) {
            for (var i = 10; i > 0; i--) {
                for (var j = 5; j > 0; j--) {
                    window.top.moveBy(0, i);
                    window.top.moveBy(i, 0);
                    window.top.moveBy(0, -i);
                    window.top.moveBy(-i, 0);
                }
            }
        } else {
            console.log('暂不支持！');
        }

    }

    function call() {
        var audioElementHovertree = document.createElement('audio');
        audioElementHovertree.setAttribute('src', 'http://w.qq.com/audio/classic.mp3');
        audioElementHovertree.setAttribute('autoplay', 'autoplay'); //打开自动播放
    }

</script>
</html>